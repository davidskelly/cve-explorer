package com.example.cveexplorer;

import com.example.cveexplorer.controller.CveExplorerController;
import com.example.cveexplorer.entity.Cve;
import com.example.cveexplorer.repository.CveRepository;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.MediaType;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.test.web.servlet.ResultActions;

import java.util.Optional;

import static org.assertj.core.api.Assertions.assertThat;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

@SpringBootTest
@AutoConfigureMockMvc
public class CveExplorerControllerTests {

	@Autowired
	private CveExplorerController controller;

	@Autowired
	private CveRepository cveRepository;

	@Autowired
	private MockMvc mockMvc;

	@Autowired
	private ObjectMapper objectMapper;


	@Test
	public void contextLoads() throws Exception {
		assertThat(controller).isNotNull();
	}

	@Test
	public void testCveCreateSuccess() throws Exception {
		// GIVEN: new CVE data
		Cve newCveData = new Cve();
		newCveData.setDescription("test cve");
		newCveData.setSeverity("low");

		// WHEN: a new CVE is created
		ResultActions results = mockMvc.perform(
				post("/cve")
						.content(objectMapper.writeValueAsString(newCveData))
						.contentType(MediaType.APPLICATION_JSON));

		// THEN: the cve is successfully created
		results.andExpect(status().isCreated());

		Cve createdCve = objectMapper.readValue(
				results.andReturn().getResponse().getContentAsString(), Cve.class);

		// THEN: the cve is present in the database
		assertThat(cveRepository.findByCveId(createdCve.getCveId()).isPresent()).isEqualTo(true);
	}

	@Test
	public void testCveCreateFailureInvalidData() throws Exception {
		// GIVEN: CVE data missing description
		Cve newCveData = new Cve();
		newCveData.setSeverity("low");

		// WHEN: a new CVE is created
		ResultActions results = mockMvc.perform(
				post("/cve")
						.content(objectMapper.writeValueAsString(newCveData))
						.contentType(MediaType.APPLICATION_JSON));

		// THEN: the cve has been rejected
		results.andExpect(status().is4xxClientError());
	}

	@Test
	public void testCveGetSuccess() throws Exception {
		// GIVEN: existing Cve
		cveRepository.save(new Cve().setCveId("CVE-1111").setDescription("test 1234"));

		// WHEN: the cve is retrieved
		ResultActions results = mockMvc.perform(get("/cve/CVE-1111"));

		// THEN: the cve has been retrieved
		Cve retrievedCve = objectMapper.readValue(
				results.andReturn().getResponse().getContentAsString(), Cve.class);

		// THEN: the contents of the CVE match
		assertThat(retrievedCve.getCveId()).isEqualTo("CVE-1111");
		assertThat(retrievedCve.getDescription()).isEqualTo("test 1234");
	}

	@Test
	public void testCveGetFailure() throws Exception {
		// GIVEN: a non-existent cve

		// WHEN: the cve is retrieved
		ResultActions results = mockMvc.perform(get("/cve/CVE-non-existant"));

		// THEN: a 404 is returned
		results.andExpect(status().isNotFound());
	}

	@Test
	public void testCveSearchSuccess() throws Exception {
		// GIVEN: existing Cves
		cveRepository.save(new Cve().setCveId("CVE-2111").setDescription("yellow"));
		cveRepository.save(new Cve().setCveId("CVE-2112").setDescription("white"));

		// WHEN: the cve is searched
		ResultActions results = mockMvc.perform(get("/cve/search?search=yellow"));

		Cve[] retrievedCves = objectMapper.readValue(
				results.andReturn().getResponse().getContentAsString(), Cve[].class);

		// THEN: the wordpress cve has been found
		assertThat(retrievedCves.length).isEqualTo(1);
		assertThat(retrievedCves[0].getDescription()).isEqualTo("yellow");
	}

	@Test
	public void testCveSearchEmpty() throws Exception {
		// GIVEN: existing Cves
		cveRepository.save(new Cve().setCveId("CVE-3111").setDescription("orange"));
		cveRepository.save(new Cve().setCveId("CVE-3112").setDescription("blue"));

		// WHEN: the cve is searched with no search string
		ResultActions results = mockMvc.perform(get("/cve/search?search="));

		Cve[] retrievedCves = objectMapper.readValue(
				results.andReturn().getResponse().getContentAsString(), Cve[].class);

		// THEN: an empty list is returned
		assertThat(retrievedCves.length).isEqualTo(0);
	}

	@Test
	public void testCveSearchNoResults() throws Exception {
		// GIVEN: existing Cves
		cveRepository.save(new Cve().setCveId("CVE-4111").setDescription("red"));
		cveRepository.save(new Cve().setCveId("CVE-4112").setDescription("green"));

		// WHEN: the cve is searched with no matching items
		ResultActions results = mockMvc.perform(get("/cve/search?search=nothing"));

		Cve[] retrievedCves = objectMapper.readValue(
				results.andReturn().getResponse().getContentAsString(), Cve[].class);

		// THEN: an empty list is returned
		assertThat(retrievedCves.length).isEqualTo(0);
	}

	@Test
	public void testCveDeleteSuccess() throws Exception {
		// GIVEN: existing Cve
		cveRepository.save(new Cve().setCveId("CVE-5111").setDescription("test 1234"));

		// WHEN: the cve is deleted
		ResultActions results = mockMvc.perform(delete("/cve/CVE-5111"));

		// THEN: the cve has been deleted
		results.andExpect(status().is2xxSuccessful());

		// THEN: the cve is no longer in the database
		Optional<Cve> deletedItem = cveRepository.findByCveId("CVE-5111");
		assertThat(deletedItem.isEmpty());
	}

	@Test
	public void testCveDeleteFailure() throws Exception {
		// GIVEN: no Cve

		// WHEN: the cve is retrieved
		ResultActions results = mockMvc.perform(delete("/cve/CVE-non-existant"));

		// THEN: the cve has been deleted
		results.andExpect(status().isNotFound());
	}

	@Test
	public void testCvePutSuccessCreated() throws Exception {
		// GIVEN: new CVE data
		Cve newCveData = new Cve();
		newCveData.setDescription("test put cve");
		newCveData.setSeverity("low");

		// WHEN: a new CVE is put
		ResultActions results = mockMvc.perform(
				put("/cve/CVE-6111")
						.content(objectMapper.writeValueAsString(newCveData))
						.contentType(MediaType.APPLICATION_JSON));

		// THEN: the cve is successfully created
		results.andExpect(status().isCreated());

		Cve createdCve = objectMapper.readValue(
				results.andReturn().getResponse().getContentAsString(), Cve.class);

		// THEN: the cve is present in the database
		assertThat(cveRepository.findByCveId(createdCve.getCveId()).isPresent()).isEqualTo(true);
	}

	@Test
	public void testCvePutSuccessReplaced() throws Exception {
		// GIVEN: existing Cve
		cveRepository.save(new Cve().setCveId("CVE-7111").setDescription("test put replace 1234"));

		Cve newCveData = new Cve();
		newCveData.setDescription("test put replace 2222");
		newCveData.setSeverity("low");

		// WHEN: an existing CVE is put
		ResultActions results = mockMvc.perform(
				put("/cve/CVE-7111")
						.content(objectMapper.writeValueAsString(newCveData))
						.contentType(MediaType.APPLICATION_JSON));

		// THEN: the cve is successfully updated
		results.andExpect(status().isOk());

		Cve updatedCve = objectMapper.readValue(
				results.andReturn().getResponse().getContentAsString(), Cve.class);

		// THEN: the cve response is correct
		assertThat(updatedCve.getDescription()).isEqualTo("test put replace 2222");

		// THEN: the cve is present in the database
		assertThat(cveRepository.findByCveId(updatedCve.getCveId()).isPresent()).isEqualTo(true);

		// THEN: the cve has been updated
		assertThat(cveRepository.findByCveId(updatedCve.getCveId()).get().getDescription()).isEqualTo("test put replace 2222");
	}
}

package com.example.cveexplorer.config;

import com.example.cveexplorer.repository.CveRepository;
import com.example.cveexplorer.feed.Feed;
import com.example.cveexplorer.feed.RefreshFeeds;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.CommandLineRunner;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
class InitFeeds {

	private static final Logger LOG = LoggerFactory.getLogger(InitFeeds.class);

	private static final String FEED_LOCATION = "com.example.cveexplorer.feed.";

	// setting indicating what feeds are enabled
	@Value("${feeds}")
	private String feeds;

	/**
	 * Use application.properties to instantiate appropriate feeds.
	 */
	@Bean
	CommandLineRunner initAllFeeds() {

		LOG.info("adding external feeds");

		for (String feed : feeds.split(",")) {
			if (feed.length() > 0) {
				try {
					Feed f = (Feed) Class.forName(FEED_LOCATION + feed).getDeclaredConstructor().newInstance();
					RefreshFeeds.addFeed(f);
					LOG.info("Added external feed: " + feed);

				} catch (Exception e) {
					LOG.warn("Failed to add feed: " + feed, e);
				}
			}
		}

		return args -> {

		};
	}
}
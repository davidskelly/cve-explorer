declare var $;

class Cve {
	public id: number;
	public cveId: string;
	public description: string;
	public severity: string;
	public published: string;
	public modified: string;
	public source: string;
}

let SEVERITY_CLASS = {
	"": "severity_unknown",
	"low": "severity_low",
	"medium": "severity_medium",
	"high": "severity_high",
}

// var entityMap = {
// 	'&': '&amp;',
// 	'<': '&lt;',
// 	'>': '&gt;',
// 	'"': '&quot;',
// 	"'": '&#39;',
// 	'/': '&#x2F;',
// 	'`': '&#x60;',
// 	'=': '&#x3D;'
// };
//
// function escapeHtml2(string) {
// 	return String(string).replace(/[&<>"'`=\/]/g, function fromEntityMap(s) {
// 		return entityMap[s];
// 	});
// }

function escapeHtml(htmlStr) {
	return htmlStr.replace(/&/g, "&amp;")
		.replace(/</g, "&lt;")
		.replace(/>/g, "&gt;")
		.replace(/"/g, "&quot;")
		.replace(/'/g, "&#39;");

}

function getListResults(response) {
	let html = "<div class='list-group'>";
	for (let item in response) {
		let cve: Cve = response[item];

		let severity_class = SEVERITY_CLASS[cve.severity ? cve.severity.toLocaleLowerCase() : ""];
		if (!severity_class) {
			severity_class = "";
		}

		html += `
		<div class='list-group-item ${severity_class}'>
			<div><span class='cve_id'>${escapeHtml(cve.cveId)}</span> [${escapeHtml(cve.source)}] 
				<span class='cve_published'>${new Date(cve.published).toLocaleDateString()}</span></div>
			<div><span class='cve_description'>${escapeHtml(cve.description)}</span></div>
		</div>
		`;
	}
	html += "</div>";

	return html;
}

function searchCve() {
	let val = $(".input_search").val();

	let data = {
		search: val
	}
	let url = "http://localhost:8080/cve/search";

	$.ajax({
		url: url,
		type: "GET",
		data: data,
		success: function (response, status, jqxhr) {
			console.log(response);
			let html = getListResults(response);
			$(".search_results").html(html);
		},
		error: function (response) {
			console.log(response);
		},
		dataType: "json"
	});
}

function checkTopCves() {
	let url = "http://localhost:8080/cve/recent";
	console.log("checking top cve's");

	$.ajax({
		url: url,
		type: "GET",
		success: function (response, status, jqxhr) {
			console.log(response);
			let html = getListResults(response);
			$(".top_cves").html(html);
		},
		error: function (response) {
			console.log(response);
		},
		dataType: "json"
	});

	setTimeout(checkTopCves, 1000 * 30);
}

$(function () {
	$(".input_search").on("keyup touchend", function () {
		searchCve();
	});

	checkTopCves();
});
